Проект представляет собой ASP.NET Core Web API приложение для управления книжным магазином, настроенное для работы в Docker контейнерах.

---

## Архитектура

Проект состоит из двух Docker сервисов:

1. **sql** - SQL Server 2022 контейнер с базой данных
2. **web** - ASP.NET Core 9.0 Web API приложение

Взаимодействие между сервисами настроено через Docker Compose

--- 

## Как это работает

Когда мы запускаем `docker-compose up --build`, процесс разворачивания проекта проходит последовательно, шаг за шагом, под капотом Docker Compose. Сначала Compose читает файл `docker-compose.yml` и определяет два сервиса: `sql` и `web`. Он начинает с `sql`, потому что `web` зависит от него.

Для сервиса `sql` Docker Compose использует указанный `Dockerfile.sql`. Сначала происходит сборка образа: на этапе сборки устанавливаются необходимые пакеты и инструменты (`msodbcsql18`, `mssql-tools`), затем копируется папка `init-db`, где лежит резервная копия базы `BookstoreDb.bak`.Когда образ готов, Compose создаёт контейнер и запускает его. На старте контейнера выполняется команда CMD, которая поднимает SQL Server, ждёт около 5 секунд для инициализации и проверяет наличие файла резервной копии. Если база `BookstoreDb` ещё не существует, выполняется её восстановление из `.bak` файла. После этого SQL Server полностью готов к работе, и контейнер слушает порт 1433 для входящих соединений.

Когда контейнер `sql` запущен, Compose переходит к сервису `web`. Для него используется основной `Dockerfile`, который тоже многоэтапный. На этапе `build` используется .NET SDK 9.0: Docker восстанавливает зависимости, компилирует проект и публикует его в отдельную папку внутри образа. На этапе `runtime` берется минимальный ASP.NET Runtime 9.0, и в него копируется уже собранное приложение. Контейнер настраивает порт 8080 и запускает Web API с помощью `dotnet WebApi.dll`.

В этот момент веб-приложение начинает работать и использует переменную окружения `ConnectionStrings__BookShopConnection` (заменяет строку подключения по названию BookShopConnection в проекте) для подключения к базе данных SQL Server, которая теперь доступна по имени контейнера `sql` и порту 1433. Web API может отправлять запросы к базе, обрабатывать данные и отдавать результаты по HTTP. Весь процесс автоматизирован: Compose сначала строит образы, затем запускает контейнеры в правильном порядке, а внутренние скрипты в контейнерах заботятся о том, чтобы база данных и веб-приложение были полностью готовы к работе.

---

## Требования

- Docker Desktop (или Docker Engine + Docker Compose)
- Файл базы данных `BookstoreDb.bak` в папке `./init-db/`

P.S. Можно заменить бэкап, но в этом случае потребуется либо изменить соответствующие названия в Dockerfile.sql, либо создать бэкап с таким же именем.

---

## Настройка перед запуском

Перед запуском необходимо настроить следующие параметры в `docker-compose.yml`:

Измените пароль администратора SQL Server:

```yaml
environment:
  SA_PASSWORD: "ВАШ_ПАРОЛЬ"
```

Обновите строку подключения в сервисе `web`, чтобы она соответствовала вашему паролю:

```yaml
environment:
  ConnectionStrings__BookShopConnection: "Server=sql,1433;Database=BookstoreDb;User Id=sa;Password=ВАШ_ПАРОЛЬ;TrustServerCertificate=True;"
```

P.S. **ВАЖНО!!!** Пароль менять необязательно — по умолчанию установлен P@ssw0rd123!.
Если решите задать свой пароль, обязательно соблюдайте политику паролей SQL Server:
- Минимум 8 символов.
- Обязательно **строчные + заглавные буквы + цифры + специальные символы**.

---

## Запуск приложения

Собрать и запустить контейнеры можно командой:

```bash
docker-compose up --build
```

Собрать и запустить контейнеры в фоне:

```bash
docker-compose up --d
```

## Собрать готовый образ

Собрать и запустить контейнеры. Командой сохранить образы:

```bash
docker save -o webapi-sql.tar webapi-sql:latest
docker save -o webapi-web.tar webapi-web:latest
```

На другой машине загрузить образы: 

```bash
docker load -i webapi-sql.tar
docker load -i webapi-web.tar
```

Собрать и запустить контейнеры можно командой:

```bash
docker-compose up --build
```

P.S. **ВАЖНО!!!** Обязательно должна быть папка init-db с бэкапом. Также, нужно изменить docker-compose, либо скопировать его из папки Release-docker

